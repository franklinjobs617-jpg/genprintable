<!DOCTYPE html>
<html lang="zh">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GenPrintable - å‰ªè´´æ‰‹å·¥ç”Ÿæˆå™¨</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-L157KWFB78"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());

        gtag('config', 'G-L157KWFB78');
    </script>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            display: flex;
            height: 100vh;
            margin: 0;
            background-color: #f4f4f4;
        }

        .sidebar {
            width: 250px;
            background-color: #fff;
            padding: 15px;
            box-shadow: 2px 0 5px rgba(0, 0, 0, 0.1);
            overflow-y: auto;
        }

        .main-content {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }

        .toolbar {
            padding: 10px;
            background-color: #eee;
            display: flex;
            gap: 10px;
            border-bottom: 1px solid #ccc;
        }

        .canvas-container {
            flex-grow: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: #ddd;
        }

        /* é¢„è§ˆç”»å¸ƒï¼šæ¨¡æ‹Ÿ A4 çº¸ */
        #preview-canvas {
            width: 400px;
            /* é¢„è§ˆå°ºå¯¸ */
            height: 565px;
            background-color: white;
            border: 1px solid #333;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.2);
        }

        /* é›¶ä»¶æ ·å¼ */
        .part-preview {
            cursor: pointer;
            border: 1px solid transparent;
            padding: 5px;
            margin: 5px;
            border-radius: 5px;
        }

        .part-preview:hover {
            border-color: #007bff;
        }

        .part-item {
            cursor: grab;
        }

        .part-item:hover {
            opacity: 0.8;
        }

        .section-title {
            margin-top: 15px;
            border-bottom: 1px solid #ccc;
            padding-bottom: 5px;
            font-weight: bold;
        }

        /* é€‰ä¸­çŠ¶æ€ */
        .selected-part {
            outline: 2px dashed red;
            /* é€‰ä¸­è¾¹æ¡† */
            cursor: move !important;
        }

        /* æ‰“å°å®¹å™¨éšè— */
        #print-layout-container {
            position: absolute;
            top: -5000px;
            /* ç§»å‡ºè§†å£ */
            width: 794px;
            /* A4 å°ºå¯¸ 72dpi */
            height: 1123px;
            background-color: white;
            padding: 20px;
        }
    </style>
</head>

<body>

    <div class="sidebar">
        <h2>ğŸ› ï¸ é…ç½®é¢æ¿</h2>

        <div id="part-selection">
            <div class="section-title">ğŸ“¦ é›¶ä»¶åŒ… (æé¾™ä¸»é¢˜)</div>
            <p>ç‚¹å‡»é›¶ä»¶æ·»åŠ åˆ°ç”»å¸ƒï¼š</p>
            <div id="parts-kit">
            </div>
        </div>

        <hr>

        <div id="part-config">
            <div class="section-title">âš™ï¸ è°ƒæ•´é€‰ä¸­é›¶ä»¶</div>
            <p id="selected-info">è¯·é€‰æ‹©ä¸€ä¸ªé›¶ä»¶ã€‚</p>

            <label for="partColor">å¡«å……é¢œè‰²:</label>
            <input type="color" id="partColor" value="#508D4E" oninput="changeSelectedPartColor(this.value)" disabled>

            <button onclick="deleteSelectedPart()" style="margin-top: 10px; display: block;">ğŸ—‘ï¸ åˆ é™¤é›¶ä»¶</button>
        </div>
    </div>

    <div class="main-content">
        <div class="toolbar">
            <h1>GenPrintable.com</h1>
            <button onclick="exportToPDF()"
                style="background-color: #28a745; color: white; border: none; padding: 10px 20px; cursor: pointer;">
                ğŸ“¥ ç”Ÿæˆå¯æ‰“å° PDF
            </button>
        </div>

        <div class="canvas-container">
            <svg id="preview-canvas" viewBox="0 0 400 565"></svg>
        </div>
    </div>

    <div id="print-layout-container">
    </div>

    <script>
        const canvas = document.getElementById('preview-canvas');
        const printContainer = document.getElementById('print-layout-container');
        const partsKitDiv = document.getElementById('parts-kit');
        let selectedPart = null;
        let isDragging = false;
        let currentX;
        let currentY;
        let initialX;
        let initialY;
        let xOffset = 0;
        let yOffset = 0;

        // --- 1. é¢„è®¾é›¶ä»¶ SVG æ•°æ® (æé¾™ä¸»é¢˜) ---
        const PARTS = [
            { id: 'body', name: 'èº«ä½“', color: '#508D4E', svg: '<path d="M50,50 C 150,0 250,100 250,150 C 200,250 50,200 50,50 Z"/>' },
            { id: 'head', name: 'å¤´éƒ¨', color: '#60A917', svg: '<circle cx="100" cy="100" r="40"/>' },
            { id: 'leg', name: 'è…¿', color: '#407D3E', svg: '<rect x="0" y="0" width="20" height="60" rx="10"/>' },
            { id: 'eye', name: 'çœ¼ç›', color: 'white', svg: '<circle cx="10" cy="10" r="5" fill="white" stroke="black" stroke-width="2"/>' }
        ];

        // --- 2. äº¤äº’æ§åˆ¶å‡½æ•° ---

        function setSelectedPart(part) {
            if (selectedPart) {
                selectedPart.classList.remove('selected-part');
            }
            selectedPart = part;
            if (part) {
                part.classList.add('selected-part');
                document.getElementById('selected-info').textContent = `é€‰ä¸­: ${part.getAttribute('data-name')}`;
                document.getElementById('partColor').value = part.getAttribute('fill');
                document.getElementById('partColor').disabled = false;
            } else {
                document.getElementById('selected-info').textContent = 'è¯·é€‰æ‹©ä¸€ä¸ªé›¶ä»¶ã€‚';
                document.getElementById('partColor').disabled = true;
            }
        }

        function changeSelectedPartColor(color) {
            if (selectedPart) {
                selectedPart.setAttribute('fill', color);
            }
        }

        function deleteSelectedPart() {
            if (selectedPart) {
                selectedPart.remove();
                setSelectedPart(null);
            }
        }

        // --- 3. æ‹–æ‹½é€»è¾‘ (åŸºç¡€) ---

        canvas.addEventListener('mousedown', dragStart);
        canvas.addEventListener('mouseup', dragEnd);
        canvas.addEventListener('mousemove', drag);

        function dragStart(e) {
            // æ‰¾åˆ°ç‚¹å‡»çš„ SVG å…ƒç´  (part-item)
            const target = e.target.closest('.part-item');
            if (target) {
                setSelectedPart(target);
                isDragging = true;
                e.preventDefault();

                // è·å–åˆå§‹ç‚¹å‡»åæ ‡ (ç›¸å¯¹äº SVG viewBox)
                const point = canvas.createSVGPoint();
                point.x = e.clientX;
                point.y = e.clientY;
                const CTM = canvas.getScreenCTM().inverse();
                const initialPoint = point.matrixTransform(CTM);

                initialX = initialPoint.x;
                initialY = initialPoint.y;

                // è·å–åˆå§‹è½¬æ¢å€¼
                const transform = target.getAttribute('transform');
                const match = transform ? transform.match(/translate\(([^,]+),([^)]+)\)/) : null;
                xOffset = match ? parseFloat(match[1]) : 0;
                yOffset = match ? parseFloat(match[2]) : 0;
            } else {
                setSelectedPart(null);
            }
        }

        function dragEnd(e) {
            isDragging = false;
        }

        function drag(e) {
            if (!isDragging || !selectedPart) return;
            e.preventDefault();

            const point = canvas.createSVGPoint();
            point.x = e.clientX;
            point.y = e.clientY;
            const CTM = canvas.getScreenCTM().inverse();
            const currentPoint = point.matrixTransform(CTM);

            const dx = currentPoint.x - initialX;
            const dy = currentPoint.y - initialY;

            currentX = xOffset + dx;
            currentY = yOffset + dy;

            selectedPart.setAttribute('transform', `translate(${currentX}, ${currentY})`);
        }

        // --- 4. åˆå§‹åŒ–å’Œæ·»åŠ é›¶ä»¶ ---

        function createPart(partData) {
            const group = document.createElementNS('http://www.w3.org/2000/svg', 'g');
            group.innerHTML = partData.svg;

            // è·å–å®é™…çš„ SVG å…ƒç´ ï¼ˆå¯èƒ½æ˜¯ path, circle, rect ç­‰ï¼‰
            const partElement = group.children[0];

            // è®¾ç½®åˆå§‹å±æ€§
            partElement.setAttribute('fill', partData.color);
            partElement.setAttribute('stroke', 'black');
            partElement.setAttribute('stroke-width', 2);
            partElement.classList.add('part-item');
            partElement.setAttribute('data-name', partData.name);

            // éšæœºåˆå§‹ä½ç½®
            const randX = Math.floor(Math.random() * 150) + 50;
            const randY = Math.floor(Math.random() * 150) + 50;
            partElement.setAttribute('transform', `translate(${randX}, ${randY})`);

            canvas.appendChild(partElement);
        }

        function initPartKit() {
            PARTS.forEach(part => {
                const div = document.createElement('div');
                div.classList.add('part-preview');
                div.innerHTML = part.name;
                div.onclick = () => createPart(part);
                partsKitDiv.appendChild(div);
            });
        }

        // --- 5. æ ¸å¿ƒï¼šç”Ÿæˆå¯æ‰“å° PDF é€»è¾‘ (æ‰“å°å¸ƒå±€å’Œè™šçº¿å‰ªåˆ‡çº¿) ---

        function createCutline(svgElement) {
            const cutline = svgElement.cloneNode(true);

            // æ¸…é™¤å¡«å……ï¼Œæ·»åŠ è™šçº¿æè¾¹
            cutline.setAttribute('fill', 'none');
            cutline.setAttribute('stroke', 'black');
            cutline.setAttribute('stroke-width', 3); // å‰ªåˆ‡çº¿å¯ä»¥ç²—ä¸€ç‚¹
            cutline.setAttribute('stroke-dasharray', '5 5'); // è™šçº¿

            // æ”¾å¤§ä¸€ç‚¹ï¼Œç¡®ä¿è™šçº¿åœ¨å®çº¿å¤–éƒ¨
            const transform = svgElement.getAttribute('transform');
            cutline.setAttribute('transform', `${transform} scale(1.05)`);

            return cutline;
        }

        async function exportToPDF() {
            // 1. æ¸…ç©ºå¹¶å‡†å¤‡éšè—çš„æ‰“å°å®¹å™¨
            printContainer.innerHTML = '';

            // 2. è·å–æ‰€æœ‰é›¶ä»¶
            const parts = Array.from(canvas.querySelectorAll('.part-item'));
            if (parts.length === 0) {
                alert('è¯·å…ˆåœ¨ç”»å¸ƒä¸Šæ·»åŠ é›¶ä»¶ï¼');
                return;
            }

            let currentX = 20; // æ‰“å°å¸ƒå±€çš„èµ·å§‹X
            let currentY = 20; // æ‰“å°å¸ƒå±€çš„èµ·å§‹Y
            const maxX = 750; // A4 çº¸å®½åº¦é™åˆ¶ (çº¦794px)
            const margin = 10; // é›¶ä»¶é—´è·

            // 3. è‡ªåŠ¨å¸ƒå±€å’Œæ·»åŠ è™šçº¿å‰ªåˆ‡çº¿
            parts.forEach(part => {
                // å…‹éš†å®çº¿é›¶ä»¶
                const solidPart = part.cloneNode(true);
                solidPart.classList.remove('selected-part');

                // åˆ›å»ºè™šçº¿å‰ªåˆ‡çº¿
                const cutlinePart = createCutline(part);

                // è·å–é›¶ä»¶çš„å°ºå¯¸ (è¿™é‡Œä½¿ç”¨ bbox è·å–çš„æ˜¯ SVG çš„åŸå§‹å°ºå¯¸)
                const bbox = part.getBBox();
                const partWidth = bbox.width * 1.05; // è€ƒè™‘æ”¾å¤§çš„å‰ªåˆ‡çº¿
                const partHeight = bbox.height * 1.05;

                // ç®€å•çš„è‡ªåŠ¨æ¢è¡Œå¸ƒå±€é€»è¾‘
                if (currentX + partWidth + margin > maxX) {
                    currentX = 20; // æ¢è¡Œ
                    currentY += partHeight + margin;
                }

                // åˆ›å»ºä¸€ä¸ªç»„ï¼ŒåŒ…å«è™šçº¿å’Œå®çº¿é›¶ä»¶
                const partGroup = document.createElementNS('http://www.w3.org/2000/svg', 'g');
                partGroup.setAttribute('transform', `translate(${currentX}, ${currentY})`);

                // ç§»é™¤åŸæœ‰è½¬æ¢ï¼Œä½¿å…¶åœ¨ç»„å†…ä» (0,0) å¼€å§‹
                solidPart.setAttribute('transform', '');
                cutlinePart.setAttribute('transform', 'scale(1.05)'); // åªä¿ç•™ç¼©æ”¾

                partGroup.appendChild(cutlinePart);
                partGroup.appendChild(solidPart);

                printContainer.appendChild(partGroup);

                currentX += partWidth + margin; // ç§»åŠ¨åˆ°ä¸‹ä¸€ä¸ªä½ç½®
            });

            // 4. å°†æ‰“å°å®¹å™¨ï¼ˆç°åœ¨é‡Œé¢æ˜¯æ‰€æœ‰æ‹†æ•£çš„é›¶ä»¶ï¼‰å¯¼å‡ºä¸º PDF
            alert('æ­£åœ¨ç”Ÿæˆ PDFï¼Œè¯·ç¨å€™...');

            // ç¡®ä¿æ‰“å°å®¹å™¨å¯è§ä¸”æœ‰å†…å®¹
            printContainer.style.position = 'static'; // ä¸´æ—¶æ˜¾ç¤º

            const element = printContainer;

            // ä½¿ç”¨ html2canvas å°† SVG DOM æ¸²æŸ“ä¸º Canvas (é«˜åˆ†è¾¨ç‡)
            html2canvas(element, { scale: 1.5, useCORS: true }).then(canvas => {
                const pdf = new jsPDF('p', 'mm', 'a4');
                const imgData = canvas.toDataURL('image/png');

                const imgWidth = 210; // A4 å®½åº¦ (mm)
                const imgHeight = canvas.height * imgWidth / canvas.width;

                pdf.addImage(imgData, 'PNG', 0, 0, imgWidth, imgHeight);
                pdf.save('GenPrintable_Craft.pdf');

                // æ¢å¤éšè—
                printContainer.style.position = 'absolute';
                printContainer.innerHTML = '';
                alert('PDF ç”ŸæˆæˆåŠŸï¼');
            }).catch(error => {
                console.error('PDF å¯¼å‡ºå¤±è´¥:', error);
                alert('PDF å¯¼å‡ºå¤±è´¥ï¼Œè¯·æ£€æŸ¥æ§åˆ¶å°é”™è¯¯ã€‚');
                printContainer.style.position = 'absolute';
            });
        }

        // é¡µé¢åŠ è½½å®Œæˆæ—¶åˆå§‹åŒ–
        window.onload = () => {
            initPartKit();
            // é»˜è®¤åˆ›å»ºä¸€ä¸ªå¤´éƒ¨å’Œèº«ä½“
            createPart(PARTS[0]);
            createPart(PARTS[1]);
        };
    </script>

</body>

</html>