<!DOCTYPE html>
<html lang="en" class="scroll-smooth">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Connect Dots Generator - GenPrintable</title>

    <!-- Core Tech Stack -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link
        href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap"
        rel="stylesheet">

    <!-- PDF Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-L157KWFB78"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());

        gtag('config', 'G-L157KWFB78');
    </script>
    <script type="text/javascript">
        (function (c, l, a, r, i, t, y) {
            c[a] = c[a] || function () { (c[a].q = c[a].q || []).push(arguments) };
            t = l.createElement(r); t.async = 1; t.src = "https://www.clarity.ms/tag/" + i;
            y = l.getElementsByTagName(r)[0]; y.parentNode.insertBefore(t, y);
        })(window, document, "clarity", "script", "ui3yobacy1");
    </script>
    <!-- Tailwind Config (Copied from your Homepage) -->
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        display: ['Outfit', 'sans-serif'],
                        sans: ['Plus Jakarta Sans', 'sans-serif'],
                    },
                    colors: {
                        // Brand: Teal
                        brand: { 50: '#ecfdf5', 100: '#d1fae5', 200: '#a7f3d0', 400: '#34d399', 500: '#10b981', 600: '#059669', 700: '#047857', 900: '#064e3b' },
                        // Accent: Coral/Purple (Using your config)
                        accent: { 50: '#f5f3ff', 100: '#ede9fe', 500: '#8b5cf6', 600: '#7c3aed' },
                        // Paper
                        paper: { 50: '#fafaf9', 100: '#f5f5f4', 200: '#e7e5e4', 800: '#292524', 900: '#1c1917' }
                    },
                    boxShadow: {
                        'paper': '0 20px 60px -12px rgba(0, 0, 0, 0.25)',
                        'drawer': '0 -10px 40px -10px rgba(0,0,0,0.1)'
                    }
                }
            }
        }
    </script>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-L157KWFB78"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());

        gtag('config', 'G-L157KWFB78');
    </script>
    <style>
        /* Custom Scrollbar */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: transparent;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background-color: #cbd5e1;
            border-radius: 20px;
        }

        .dark .custom-scrollbar::-webkit-scrollbar-thumb {
            background-color: #475569;
        }

        /* Dot Background Pattern */
        .hero-bg {
            background-color: #f8fafc;
            background-image: radial-gradient(#cbd5e1 1.5px, transparent 1.5px);
            background-size: 24px 24px;
        }

        .dark .hero-bg {
            background-color: #020617;
            /* Slate 950 */
            background-image: radial-gradient(#1e293b 1.5px, transparent 1.5px);
        }

        /* Drawer Transitions (Mobile) */
        .drawer-transition {
            transition: transform 0.3s cubic-bezier(0.32, 0.72, 0, 1);
        }

        .mobile-drawer-closed {
            transform: translateY(100%);
        }

        .mobile-drawer-open {
            transform: translateY(0);
        }

        @media (min-width: 1024px) {

            .mobile-drawer-closed,
            .mobile-drawer-open {
                transform: none !important;
            }
        }

        /* Range Slider Customization to match Brand */
        input[type=range] {
            -webkit-appearance: none;
            background: transparent;
        }

        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 18px;
            width: 18px;
            border-radius: 50%;
            background: #059669;
            /* Brand 600 */
            cursor: pointer;
            margin-top: -7px;
            box-shadow: 0 2px 6px rgba(5, 150, 105, 0.3);
            transition: transform 0.1s;
        }

        input[type=range]::-webkit-slider-thumb:hover {
            transform: scale(1.1);
        }

        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            cursor: pointer;
            background: #e2e8f0;
            border-radius: 2px;
        }

        .dark input[type=range]::-webkit-slider-runnable-track {
            background: #334155;
        }
    </style>
</head>

<body
    class="bg-paper-50 text-paper-800 font-sans h-[100dvh] flex flex-col overflow-hidden dark:bg-slate-950 dark:text-slate-100 selection:bg-brand-100 selection:text-brand-900">

    <!-- 1. Header (Compact Version) -->
    <header
        class="h-16 bg-white/90 dark:bg-slate-900/90 backdrop-blur-md border-b border-paper-200 dark:border-slate-800 flex items-center justify-between px-4 lg:px-8 flex-shrink-0 z-30">
        <div class="flex items-center gap-4">
            <a href="/" class="flex items-center gap-2 group">
                <div
                    class="w-8 h-8 bg-brand-600 rounded-lg flex items-center justify-center text-white shadow-lg shadow-brand-500/20 group-hover:rotate-12 transition-transform duration-300">
                    <i class="fa-solid fa-circle-nodes text-xs"></i>
                </div>
                <span
                    class="text-lg font-display font-bold tracking-tight text-paper-900 dark:text-white hidden sm:block">GenPrintable</span>
            </a>
            <div class="h-6 w-px bg-slate-200 dark:bg-slate-700 hidden sm:block"></div>
            <h1 class="text-sm font-semibold text-slate-500 dark:text-slate-400">Connect Dots Studio</h1>
        </div>

        <div class="flex items-center gap-2 lg:gap-3">
            <button id="theme-toggle"
                class="w-9 h-9 rounded-full bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-yellow-400 flex items-center justify-center hover:bg-slate-200 transition-colors">
                <i class="fa-solid fa-moon dark:hidden"></i>
                <i class="fa-solid fa-sun hidden dark:block"></i>
            </button>
            <button id="change-image-btn"
                class="hidden lg:flex items-center gap-2 px-4 py-2 text-sm font-bold text-slate-600 hover:text-brand-600 hover:bg-brand-50 rounded-xl transition-colors dark:text-slate-300 dark:hover:bg-slate-800">
                <i class="fa-solid fa-rotate-left"></i> <span class="hidden xl:inline">Start Over</span>
            </button>
            <div class="flex items-center gap-2">
                <button id="download-pdf-btn" disabled
                    class="bg-paper-900 dark:bg-brand-600 text-white px-4 py-2 rounded-xl text-sm font-bold hover:bg-black dark:hover:bg-brand-500 transition-all shadow-lg hover:shadow-xl hover:-translate-y-0.5 disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none flex items-center gap-2">
                    <i class="fa-solid fa-print"></i> <span class="hidden sm:inline">PDF</span>
                </button>
                <button id="download-png-btn" disabled
                    class="hidden lg:flex bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 text-slate-700 dark:text-slate-200 px-4 py-2 rounded-xl text-sm font-bold hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                    PNG
                </button>
            </div>
        </div>
    </header>

    <!-- 2. Main Layout -->
    <div class="flex-1 flex overflow-hidden relative">

        <!-- Mobile Backdrop -->
        <div id="backdrop" onclick="toggleDrawer()"
            class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-40 hidden lg:hidden transition-opacity"></div>

        <!-- ============================== -->
        <!-- LEFT SIDEBAR (CONFIGURATION)   -->
        <!-- ============================== -->
        <aside id="sidebar-drawer"
            class="fixed inset-x-0 bottom-0 z-50 w-full h-[85vh] bg-white dark:bg-slate-900 rounded-t-[2rem] shadow-drawer flex flex-col drawer-transition mobile-drawer-closed lg:relative lg:inset-auto lg:h-auto lg:w-[380px] xl:w-[420px] lg:border-r lg:border-slate-200 lg:dark:border-slate-800 lg:shadow-none lg:rounded-none">

            <!-- Sidebar Header (Mobile Only) -->
            <div
                class="p-5 border-b border-slate-100 dark:border-slate-800 flex justify-between items-center lg:hidden">
                <h2 class="text-lg font-display font-bold text-slate-900 dark:text-white flex items-center gap-2">
                    <i class="fa-solid fa-sliders text-brand-600"></i> Settings
                </h2>
                <button onclick="toggleDrawer()"
                    class="w-8 h-8 flex items-center justify-center bg-slate-100 dark:bg-slate-800 rounded-full text-slate-500 hover:bg-slate-200 transition-colors">
                    <i class="fa-solid fa-chevron-down"></i>
                </button>
            </div>

            <!-- Sidebar Content -->
            <div class="flex-1 overflow-y-auto p-6 space-y-8 pb-32 lg:pb-8 custom-scrollbar">

                <!-- Status & Info -->
                <div
                    class="bg-brand-50 dark:bg-brand-900/20 rounded-xl p-3 flex items-center justify-between border border-brand-100 dark:border-brand-800/50">
                    <div class="flex items-center gap-2">
                        <div id="status-indicator" class="w-2 h-2 rounded-full bg-slate-300 animate-pulse"></div>
                        <span id="opencv-status" class="text-xs font-bold text-brand-700 dark:text-brand-300">Loading
                            Engine...</span>
                    </div>
                    <span id="points-counter"
                        class="bg-white dark:bg-slate-800 px-2 py-0.5 rounded-md text-xs font-mono font-bold text-slate-600 dark:text-slate-300 shadow-sm border border-slate-100 dark:border-slate-700">0
                        Pts</span>
                </div>

                <div id="source-image-info" class="hidden text-center">
                    <p class="text-xs text-slate-400 font-medium uppercase tracking-wider mb-1">Current Image</p>
                    <p id="current-filename"
                        class="text-sm font-bold text-slate-700 dark:text-slate-200 truncate bg-slate-50 dark:bg-slate-800 py-1 px-3 rounded-lg border border-slate-100 dark:border-slate-700">
                    </p>
                </div>

                <!-- SECTION 1: Complexity -->
                <div class="space-y-4">
                    <h3 class="text-xs font-bold text-slate-400 uppercase tracking-widest ml-1">Complexity</h3>

                    <div
                        class="bg-slate-50 dark:bg-slate-800/50 p-5 rounded-2xl border border-slate-100 dark:border-slate-800">
                        <label class="flex justify-between text-sm font-bold text-slate-700 dark:text-slate-200 mb-4">
                            Point Count
                        </label>
                        <div class="flex items-center gap-3">
                            <button id="points-minus-btn"
                                class="w-9 h-9 rounded-xl bg-white dark:bg-slate-700 border border-slate-200 dark:border-slate-600 text-slate-600 dark:text-slate-300 hover:border-brand-500 hover:text-brand-600 transition-all flex-shrink-0 shadow-sm"><i
                                    class="fa-solid fa-minus text-xs"></i></button>
                            <input type="range" id="dot-count-slider" min="10" max="150" value="25" class="w-full">
                            <button id="points-plus-btn"
                                class="w-9 h-9 rounded-xl bg-white dark:bg-slate-700 border border-slate-200 dark:border-slate-600 text-slate-600 dark:text-slate-300 hover:border-brand-500 hover:text-brand-600 transition-all flex-shrink-0 shadow-sm"><i
                                    class="fa-solid fa-plus text-xs"></i></button>
                        </div>
                        <input type="number" id="points-number-input" value="25" class="hidden">

                        <button id="clear-btn" disabled
                            class="w-full mt-4 py-2.5 bg-white dark:bg-slate-700 border border-red-200 dark:border-red-900/30 text-red-500 text-xs font-bold rounded-xl hover:bg-red-50 dark:hover:bg-red-900/20 transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2">
                            <i class="fa-regular fa-trash-can"></i> Clear All Dots
                        </button>
                    </div>
                </div>

                <!-- SECTION 2: Appearance -->
                <div class="space-y-4">
                    <h3 class="text-xs font-bold text-slate-400 uppercase tracking-widest ml-1">Appearance</h3>

                    <div class="space-y-6">
                        <!-- Font Size -->
                        <div>
                            <div
                                class="flex justify-between text-sm text-slate-600 dark:text-slate-400 mb-2 font-medium">
                                <span>Font Size</span>
                                <span id="font-size-value" class="font-bold text-slate-900 dark:text-white">20</span>
                            </div>
                            <input type="range" id="font-size-slider" min="10" max="60" value="20" class="w-full">
                        </div>

                        <!-- Dot Size -->
                        <div>
                            <div
                                class="flex justify-between text-sm text-slate-600 dark:text-slate-400 mb-2 font-medium">
                                <span>Dot Size</span>
                                <span id="dot-size-value" class="font-bold text-slate-900 dark:text-white">5</span>
                            </div>
                            <input type="range" id="dot-size-slider" min="2" max="15" value="5" class="w-full">
                        </div>

                        <!-- Dot Color -->
                        <div
                            class="flex items-center justify-between p-3 bg-slate-50 dark:bg-slate-800 rounded-xl border border-slate-100 dark:border-slate-700">
                            <span class="text-sm font-bold text-slate-700 dark:text-slate-200">Dot Color</span>
                            <div class="relative flex items-center gap-2">
                                <span class="text-xs text-slate-400 font-mono" id="color-hex">#000000</span>
                                <div
                                    class="w-8 h-8 rounded-full overflow-hidden cursor-pointer ring-2 ring-slate-200 dark:ring-slate-600 ring-offset-2 dark:ring-offset-slate-800 relative">
                                    <input type="color" id="dot-color-picker" value="#000000"
                                        class="absolute -top-1/2 -left-1/2 w-[200%] h-[200%] p-0 border-0 cursor-pointer">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- SECTION 3: Helper Hints -->
                <div class="space-y-4">
                    <h3 class="text-xs font-bold text-slate-400 uppercase tracking-widest ml-1">Helper Hints</h3>

                    <div class="grid grid-cols-1 gap-3" id="hint-type-radios">
                        <!-- Option 1 -->
                        <label
                            class="relative flex items-center gap-4 p-4 border border-slate-200 dark:border-slate-700 rounded-2xl cursor-pointer hover:bg-slate-50 dark:hover:bg-slate-800 transition-all has-[:checked]:border-brand-500 has-[:checked]:bg-brand-50/50 dark:has-[:checked]:bg-brand-900/10 has-[:checked]:shadow-sm group">
                            <input type="radio" name="hint-type" value="original" checked class="peer sr-only">
                            <div
                                class="w-5 h-5 rounded-full border-2 border-slate-300 dark:border-slate-600 peer-checked:border-brand-500 peer-checked:bg-brand-500 relative flex items-center justify-center">
                                <div class="w-2 h-2 bg-white rounded-full opacity-0 peer-checked:opacity-100"></div>
                            </div>
                            <div>
                                <div class="text-sm font-bold text-slate-800 dark:text-slate-100">Original Image</div>
                                <div class="text-xs text-slate-500 dark:text-slate-400">Show full image behind dots
                                </div>
                            </div>
                            <i
                                class="fa-regular fa-image absolute right-4 text-slate-300 peer-checked:text-brand-500 text-xl"></i>
                        </label>

                        <!-- Option 2 -->
                        <label
                            class="relative flex items-center gap-4 p-4 border border-slate-200 dark:border-slate-700 rounded-2xl cursor-pointer hover:bg-slate-50 dark:hover:bg-slate-800 transition-all has-[:checked]:border-brand-500 has-[:checked]:bg-brand-50/50 dark:has-[:checked]:bg-brand-900/10 has-[:checked]:shadow-sm group">
                            <input type="radio" name="hint-type" value="trace" class="peer sr-only">
                            <div
                                class="w-5 h-5 rounded-full border-2 border-slate-300 dark:border-slate-600 peer-checked:border-brand-500 peer-checked:bg-brand-500 relative flex items-center justify-center">
                                <div class="w-2 h-2 bg-white rounded-full opacity-0 peer-checked:opacity-100"></div>
                            </div>
                            <div>
                                <div class="text-sm font-bold text-slate-800 dark:text-slate-100">Ghost Trace</div>
                                <div class="text-xs text-slate-500 dark:text-slate-400">Faint transparent outline</div>
                            </div>
                            <i
                                class="fa-solid fa-ghost absolute right-4 text-slate-300 peer-checked:text-brand-500 text-xl"></i>
                        </label>

                        <!-- Option 3 (AI Internal) -->
                        <label
                            class="relative flex items-center gap-4 p-4 border border-slate-200 dark:border-slate-700 rounded-2xl cursor-pointer hover:bg-slate-50 dark:hover:bg-slate-800 transition-all has-[:checked]:border-brand-500 has-[:checked]:bg-brand-50/50 dark:has-[:checked]:bg-brand-900/10 has-[:checked]:shadow-sm group">
                            <input type="radio" name="hint-type" value="internal" class="peer sr-only">
                            <div
                                class="w-5 h-5 rounded-full border-2 border-slate-300 dark:border-slate-600 peer-checked:border-brand-500 peer-checked:bg-brand-500 relative flex items-center justify-center">
                                <div class="w-2 h-2 bg-white rounded-full opacity-0 peer-checked:opacity-100"></div>
                            </div>
                            <div>
                                <div class="flex items-center gap-2">
                                    <span class="text-sm font-bold text-slate-800 dark:text-slate-100">Internal
                                        Lines</span>
                                    <span
                                        class="bg-gradient-to-r from-brand-500 to-accent-500 text-white text-[9px] font-bold px-1.5 py-0.5 rounded uppercase">AI</span>
                                </div>
                                <div class="text-xs text-slate-500 dark:text-slate-400">Keep details, remove outline
                                </div>
                            </div>
                            <i
                                class="fa-solid fa-wand-magic-sparkles absolute right-4 text-slate-300 peer-checked:text-brand-500 text-xl"></i>
                        </label>

                        <!-- Option 4 -->
                        <label
                            class="relative flex items-center gap-4 p-4 border border-slate-200 dark:border-slate-700 rounded-2xl cursor-pointer hover:bg-slate-50 dark:hover:bg-slate-800 transition-all has-[:checked]:border-brand-500 has-[:checked]:bg-brand-50/50 dark:has-[:checked]:bg-brand-900/10 has-[:checked]:shadow-sm group">
                            <input type="radio" name="hint-type" value="no" class="peer sr-only">
                            <div
                                class="w-5 h-5 rounded-full border-2 border-slate-300 dark:border-slate-600 peer-checked:border-brand-500 peer-checked:bg-brand-500 relative flex items-center justify-center">
                                <div class="w-2 h-2 bg-white rounded-full opacity-0 peer-checked:opacity-100"></div>
                            </div>
                            <div>
                                <div class="text-sm font-bold text-slate-800 dark:text-slate-100">No Hint</div>
                                <div class="text-xs text-slate-500 dark:text-slate-400">Dots only (Expert mode)</div>
                            </div>
                            <i
                                class="fa-regular fa-eye-slash absolute right-4 text-slate-300 peer-checked:text-brand-500 text-xl"></i>
                        </label>
                    </div>

                    <!-- Thickness Slider (Contextual) -->
                    <div id="thickness-container"
                        class="hidden pl-4 pr-2 pt-2 border-l-2 border-brand-200 dark:border-brand-900 ml-4">
                        <div class="flex justify-between text-xs text-brand-600 dark:text-brand-400 mb-2 font-bold">
                            <span>Erase Width</span>
                            <span id="thicknessValue">5</span>
                        </div>
                        <input type="range" id="thicknessSlider" min="1" max="20" value="5"
                            class="w-full accent-brand-500">
                    </div>
                </div>
            </div>
        </aside>

        <!-- ============================== -->
        <!-- RIGHT MAIN: WORKSPACE          -->
        <!-- ============================== -->
        <main class="flex-1 flex flex-col relative w-full h-full hero-bg">

            <!-- Canvas Container -->
            <div class="flex-1 overflow-auto flex flex-col items-center relative">

                <!-- STATE 1: Empty State (Upload / AI) -->
                <div id="step1-choice-area" class="w-full max-w-4xl space-y-8 animate-fade-in-up mt-10">
                    <div class="text-center space-y-4">
                        <h2
                            class="text-4xl md:text-5xl font-display font-extrabold text-slate-900 dark:text-white tracking-tight">
                            Create Your Puzzle</h2>
                        <p class="text-lg text-slate-500 dark:text-slate-400 max-w-lg mx-auto">Upload an image or
                            describe what you want, and our AI will create a dot-to-dot activity in seconds.</p>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Upload Card -->
                        <div id="upload-choice-card"
                            class="group relative bg-white dark:bg-slate-800 rounded-[2rem] p-8 border-2 border-slate-100 dark:border-slate-700 hover:border-brand-400 dark:hover:border-brand-600 cursor-pointer shadow-xl shadow-slate-200/50 dark:shadow-none hover:-translate-y-1 transition-all duration-300">
                            <div class="flex flex-col items-center text-center h-full">
                                <div
                                    class="w-20 h-20 bg-brand-50 dark:bg-brand-900/20 rounded-2xl flex items-center justify-center text-brand-600 dark:text-brand-400 mb-6 group-hover:scale-110 transition-transform duration-300">
                                    <i class="fa-solid fa-cloud-arrow-up text-3xl"></i>
                                </div>
                                <h3 class="text-2xl font-display font-bold text-slate-900 dark:text-white mb-2">Upload
                                    Image</h3>
                                <p class="text-slate-500 dark:text-slate-400 text-sm leading-relaxed">Use your own
                                    photo, drawing, or clip art. Supports JPG, PNG, WEBP.</p>
                            </div>
                        </div>

                        <!-- AI Card -->
                        <div id="ai-choice-card"
                            class="group relative bg-white dark:bg-slate-800 rounded-[2rem] p-8 border-2 border-slate-100 dark:border-slate-700 hover:border-accent-400 dark:hover:border-accent-600 cursor-pointer shadow-xl shadow-slate-200/50 dark:shadow-none hover:-translate-y-1 transition-all duration-300">
                            <div class="flex flex-col items-center text-center h-full">
                                <div
                                    class="w-20 h-20 bg-accent-50 dark:bg-accent-900/20 rounded-2xl flex items-center justify-center text-accent-600 dark:text-accent-400 mb-6 group-hover:scale-110 transition-transform duration-300">
                                    <i class="fa-solid fa-wand-magic-sparkles text-3xl"></i>
                                </div>
                                <h3 class="text-2xl font-display font-bold text-slate-900 dark:text-white mb-2">Generate
                                    with AI</h3>
                                <p class="text-slate-500 dark:text-slate-400 text-sm leading-relaxed">Simply describe
                                    what you want (e.g. "A cute baby dinosaur"), and we'll draw it.</p>
                            </div>
                        </div>
                    </div>

                    <!-- Hidden Action Containers (Populated by JS) -->
                    <div id="action-ui-container" class="mt-8 w-full max-w-2xl mx-auto"></div>

                    <!-- Inspiration -->
                    <div id="inspiration-area" class="mt-12 pt-10 border-t border-slate-200 dark:border-slate-800">
                        <p class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-6 text-center">Try an
                            example</p>
                        <div id="examples-content" class="grid grid-cols-2 sm:grid-cols-4 gap-4">
                            <img src="https://pub-476193f3c5084ebaabd517e2c8788715.r2.dev/image/connect-the-dots-baby-elephant-outline.webp"
                                class="w-full aspect-square object-contain bg-white dark:bg-slate-800 rounded-2xl border border-slate-200 dark:border-slate-700 hover:border-brand-500 cursor-pointer transition-all p-4 hover:shadow-lg">
                            <img src="https://pub-476193f3c5084ebaabd517e2c8788715.r2.dev/image/connect-the-dots-halloween-pumpkin.webp"
                                class="w-full aspect-square object-contain bg-white dark:bg-slate-800 rounded-2xl border border-slate-200 dark:border-slate-700 hover:border-brand-500 cursor-pointer transition-all p-4 hover:shadow-lg">
                            <img src="https://pub-476193f3c5084ebaabd517e2c8788715.r2.dev/image/connect-the-dots-cute-princess-drawing.webp"
                                class="w-full aspect-square object-contain bg-white dark:bg-slate-800 rounded-2xl border border-slate-200 dark:border-slate-700 hover:border-brand-500 cursor-pointer transition-all p-4 hover:shadow-lg">
                            <img src="https://pub-476193f3c5084ebaabd517e2c8788715.r2.dev/image/connect-the-dots-christmas-tree-gifts.webp"
                                class="w-full aspect-square object-contain bg-white dark:bg-slate-800 rounded-2xl border border-slate-200 dark:border-slate-700 hover:border-brand-500 cursor-pointer transition-all p-4 hover:shadow-lg">
                        </div>
                    </div>









                </div>







                <article id="seo-article"
                    class="w-full max-w-4xl mx-auto px-6 pt-16 pb-24 border-t border-slate-200 dark:border-slate-800 mt-16 animate-fade-in-up">
                    <header class="text-center mb-12">
                        <h1
                            class="text-3xl md:text-5xl font-display font-extrabold text-slate-900 dark:text-white tracking-tight mb-4">
                            The AI Connect the Dots Generator: Maximize Your Puzzle Challenge</h1>
                        <p class="text-lg text-slate-600 dark:text-slate-400 leading-relaxed max-w-2xl mx-auto">Ready to
                            move past static, simple printables? Our cutting-edge <strong
                                class="text-brand-600 dark:text-brand-400">AI Connect the Dots Generator</strong> is the
                            ultimate tool for creating custom, complex, and high-dot-count puzzles perfect for adult
                            enthusiasts, educators, and extreme challenge seekers.</p>
                    </header>

                    <figure
                        class="my-8 rounded-2xl overflow-hidden border border-slate-200 dark:border-slate-700 shadow-sm bg-white dark:bg-slate-800 p-2">
                        <!-- Placeholder visual using CSS pattern since src is empty -->

                        <div
                            class="w-full aspect-video bg-slate-100 dark:bg-slate-700 flex items-center justify-center text-slate-400 dark:text-slate-500">
                            <img src="/images/ai-dot-to-dot-generator-workflow-example.jpg" class="object-contain"
                                alt="Case Study: Teacher uses AI to create custom Multiplication Color by Number Worksheets">
                        </div>
                        <figcaption
                            class="p-4 bg-white dark:bg-slate-900 text-sm text-center text-slate-500 dark:text-slate-400 italic border-t border-slate-100 dark:border-slate-700">
                            Tired of 50-dot cat outlines? Imagine a portrait of your favorite landmark in 3,000 dots.
                        </figcaption>
                    </figure>

                    <div class="text-center mb-16">
                        <button onclick="document.getElementById('upload-choice-card').click()"
                            class="inline-flex items-center gap-2 bg-slate-900 dark:bg-brand-600 text-white px-8 py-4 rounded-full text-lg font-bold hover:scale-105 hover:shadow-xl transition-all duration-300">
                            üöÄ Launch the AI Connect the Dots Generator Now
                        </button>
                    </div>

                    <section id="ai-generator" class="mb-16">
                        <h2 class="text-2xl md:text-3xl font-display font-bold text-slate-900 dark:text-white mb-6"
                            id="solve-pain-point">Why Go AI? Solving the Static Printable Problem</h2>
                        <p class="text-slate-600 dark:text-slate-400 leading-relaxed mb-6">The vast majority of
                            printable connect-the-dots resources online suffer from three major limitations: low dot
                            counts (under 100), repetitive themes, and poor resolution for printing. The AI Generator
                            directly addresses these:</p>

                        <div
                            class="overflow-x-auto rounded-2xl border border-slate-200 dark:border-slate-700 shadow-sm bg-white dark:bg-slate-800 mb-8">
                            <table class="w-full text-left border-collapse"
                                aria-label="Comparison between Static Printables and AI Generator">
                                <thead>
                                    <tr
                                        class="bg-slate-50 dark:bg-slate-900/50 border-b border-slate-200 dark:border-slate-700">
                                        <th
                                            class="p-4 text-sm font-bold text-slate-900 dark:text-white uppercase tracking-wider">
                                            Feature</th>
                                        <th
                                            class="p-4 text-sm font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider">
                                            Static Printables</th>
                                        <th
                                            class="p-4 text-sm font-bold text-brand-600 dark:text-brand-400 uppercase tracking-wider">
                                            AI Generator (This Hub)</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-slate-100 dark:divide-slate-700">
                                    <tr>
                                        <td class="p-4 font-medium text-slate-900 dark:text-white">Max Dot Count</td>
                                        <td class="p-4 text-slate-600 dark:text-slate-400">Up to 200 (Rarely)</td>
                                        <td class="p-4 font-bold text-slate-900 dark:text-white">Up to 5000+</td>
                                    </tr>
                                    <tr>
                                        <td class="p-4 font-medium text-slate-900 dark:text-white">Customization</td>
                                        <td class="p-4 text-slate-600 dark:text-slate-400">None (Fixed Image)</td>
                                        <td class="p-4 font-bold text-slate-900 dark:text-white">Full (Upload any image)
                                        </td>
                                    </tr>
                                    <tr>
                                        <td class="p-4 font-medium text-slate-900 dark:text-white">Ideal User</td>
                                        <td class="p-4 text-slate-600 dark:text-slate-400">Casual users, children</td>
                                        <td class="p-4 font-bold text-slate-900 dark:text-white">Adults, Extreme
                                            Challenge, Educators</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <p class="text-slate-600 dark:text-slate-400 leading-relaxed">For a quick challenge, check out
                            our dedicated collection of <a href="/dots/difficulty/extreme-printable"
                                class="text-brand-600 dark:text-brand-400 hover:underline font-bold">Extreme Connect the
                                Dots</a> free printables, but remember, the AI Generator allows you to go even further.
                        </p>
                    </section>

                    <section id="key-features" class="mb-16">
                        <h2 class="text-2xl md:text-3xl font-display font-bold text-slate-900 dark:text-white mb-6">Key
                            Features: Extreme Dot Counts & Custom Themes</h2>

                        <div class="space-y-8">
                            <div>
                                <h3
                                    class="text-xl font-bold text-slate-800 dark:text-slate-100 mb-3 flex items-center gap-2">
                                    <span
                                        class="w-8 h-8 rounded-lg bg-brand-100 dark:bg-brand-900/30 text-brand-600 dark:text-brand-400 flex items-center justify-center text-sm"><i
                                            class="fa-solid fa-microchip"></i></span>
                                    The Customization Engine
                                </h3>
                                <p class="text-slate-600 dark:text-slate-400 leading-relaxed mb-4">Unlike any other
                                    tool, the Generator uses our proprietary Neural Dot Placement Algorithm to process
                                    your images. This allows for fine-tuning that results in unparalleled detail
                                    fidelity.</p>
                                <ul class="space-y-3 ml-2">
                                    <li class="flex items-start gap-3 text-slate-600 dark:text-slate-400">
                                        <i class="fa-solid fa-check text-brand-500 mt-1"></i>
                                        <span><strong>Extreme Dot Counts:</strong> Generate puzzles with dot limits up
                                            to <strong>5000+</strong>. This proprietary limit ensures a genuinely
                                            challenging experience.</span>
                                    </li>
                                    <li class="flex items-start gap-3 text-slate-600 dark:text-slate-400">
                                        <i class="fa-solid fa-check text-brand-500 mt-1"></i>
                                        <span><strong>Custom Image Upload:</strong> Turn any personal photo, abstract
                                            art, or landscape image into a dot-to-dot puzzle.</span>
                                    </li>
                                    <li class="flex items-start gap-3 text-slate-600 dark:text-slate-400">
                                        <i class="fa-solid fa-check text-brand-500 mt-1"></i>
                                        <span><strong>Format Guarantee:</strong> Output high-resolution, watermark-free
                                            <strong>PDFs</strong> instantly, optimized for any printer.</span>
                                    </li>
                                </ul>
                            </div>

                            <div>
                                <h3
                                    class="text-xl font-bold text-slate-800 dark:text-slate-100 mb-3 flex items-center gap-2">
                                    <span
                                        class="w-8 h-8 rounded-lg bg-accent-100 dark:bg-accent-900/30 text-accent-600 dark:text-accent-400 flex items-center justify-center text-sm"><i
                                            class="fa-solid fa-star"></i></span>
                                    Expert Challenge Rating
                                </h3>
                                <p class="text-slate-600 dark:text-slate-400 leading-relaxed">A leading puzzle designer
                                    has rated our extreme mode as the highest level of complexity currently achievable
                                    without digital assistance. To see what's possible, explore our existing library of
                                    <a href="/dots/adults/printable"
                                        class="text-brand-600 dark:text-brand-400 hover:underline font-bold">Connect the
                                        Dots Printable Adults</a> for high-level artistic and abstract designs.
                                </p>
                            </div>
                        </div>
                    </section>

                    <section id="how-to-create" class="mb-16">
                        <h2 class="text-2xl md:text-3xl font-display font-bold text-slate-900 dark:text-white mb-8"
                            id="how-to-create">How to Create Your Masterpiece: A 3-Step Guide</h2>

                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div
                                class="bg-white dark:bg-slate-800 p-6 rounded-2xl border border-slate-100 dark:border-slate-700 shadow-sm">
                                <div class="text-4xl font-display font-bold text-slate-200 dark:text-slate-700 mb-4">01
                                </div>
                                <h4 class="font-bold text-slate-900 dark:text-white mb-2">Upload & Adjust</h4>
                                <p class="text-sm text-slate-500 dark:text-slate-400">Upload your image (JPEG/PNG) and
                                    use the sliders to set difficulty and dot count (e.g., 500 or 1500 dots).</p>
                            </div>
                            <div
                                class="bg-white dark:bg-slate-800 p-6 rounded-2xl border border-slate-100 dark:border-slate-700 shadow-sm">
                                <div class="text-4xl font-display font-bold text-slate-200 dark:text-slate-700 mb-4">02
                                </div>
                                <h4 class="font-bold text-slate-900 dark:text-white mb-2">AI Processing</h4>
                                <p class="text-sm text-slate-500 dark:text-slate-400">Our AI instantly analyzes the
                                    image, selecting optimal dot placement to preserve key visual details.</p>
                            </div>
                            <div
                                class="bg-white dark:bg-slate-800 p-6 rounded-2xl border border-slate-100 dark:border-slate-700 shadow-sm">
                                <div class="text-4xl font-display font-bold text-slate-200 dark:text-slate-700 mb-4">03
                                </div>
                                <h4 class="font-bold text-slate-900 dark:text-white mb-2">Download & Print</h4>
                                <p class="text-sm text-slate-500 dark:text-slate-400">Review the puzzle, make final
                                    tweaks, and download your high-resolution, print-ready PDF.</p>
                            </div>
                        </div>
                    </section>

                    <section id="case-studies" class="mb-16">
                        <h2 class="text-2xl md:text-3xl font-display font-bold text-slate-900 dark:text-white mb-6">User
                            Case Studies</h2>

                        <div class="bg-brand-50 dark:bg-brand-900/10 p-6 rounded-2xl border-l-4 border-brand-500 mb-8">
                            <p class="text-slate-700 dark:text-slate-300 italic mb-4">‚ÄúThe AI‚Äôs dot optimization
                                algorithm is superior to manual placement for high-dot-count images. It maintains
                                structural integrity while drastically cutting down on production time, ensuring the
                                final image is recognizable‚Äîa key challenge for 4000+ dot puzzles.‚Äù</p>
                            <footer class="font-bold text-brand-700 dark:text-brand-400 text-sm">‚Äî Professional Puzzle
                                Designer</footer>
                        </div>

                        <h3 class="text-lg font-bold text-slate-900 dark:text-white mb-4">Related Resources:</h3>
                        <div class="flex flex-wrap gap-3">
                            <a href="/dots/theme/halloween-printable"
                                class="px-4 py-2 bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-300 rounded-lg text-sm font-medium hover:bg-brand-100 dark:hover:bg-brand-900/30 hover:text-brand-600 transition-colors">Halloween
                                Printable</a>
                            <a href="/dots/topic/alphabet-printable"
                                class="px-4 py-2 bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-300 rounded-lg text-sm font-medium hover:bg-brand-100 dark:hover:bg-brand-900/30 hover:text-brand-600 transition-colors">Alphabet
                                Dots</a>
                            <a href="/dots/format/printable-pdf"
                                class="px-4 py-2 bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-300 rounded-lg text-sm font-medium hover:bg-brand-100 dark:hover:bg-brand-900/30 hover:text-brand-600 transition-colors">Printable
                                PDF Resources</a>
                        </div>
                    </section>

                    <section id="faqs">
                        <h2 class="text-2xl md:text-3xl font-display font-bold text-slate-900 dark:text-white mb-6">FAQs
                            About the Tool</h2>
                        <div class="space-y-4">
                            <div
                                class="border border-slate-200 dark:border-slate-700 rounded-xl p-5 hover:bg-slate-50 dark:hover:bg-slate-800/50 transition-colors">
                                <dt class="font-bold text-slate-900 dark:text-white mb-2">What is the highest dot count
                                    supported?</dt>
                                <dd class="text-slate-600 dark:text-slate-400 text-sm">We support generation up to
                                    <strong>5000+ dots</strong>, far exceeding the industry standard, making it suitable
                                    for poster-sized prints.
                                </dd>
                            </div>
                            <div
                                class="border border-slate-200 dark:border-slate-700 rounded-xl p-5 hover:bg-slate-50 dark:hover:bg-slate-800/50 transition-colors">
                                <dt class="font-bold text-slate-900 dark:text-white mb-2">Is the tool suitable for
                                    commercial use?</dt>
                                <dd class="text-slate-600 dark:text-slate-400 text-sm">The generated images are yours to
                                    use. However, please ensure you own the rights to the source image you upload.</dd>
                            </div>
                        </div>
                    </section>
                </article>


















            </div>


            <div id="generator-main-area"
                class="hidden w-full h-full flex flex-col items-center justify-center dark:bg-slate-950/50 overflow-hidden relative">


                <!-- ÊèêÁ§∫ÊñáÂ≠ó (ÊÇ¨ÊµÆÂú®È°∂ÈÉ®ÊàñÂõ∫ÂÆöÂú®‰∏äÊñπ) -->
                <div class="absolute top-4 left-0 right-0 text-center z-10 pointer-events-none">
                    <span
                        class="inline-block bg-white/80 dark:bg-slate-800/80 backdrop-blur px-4 py-1.5 rounded-full text-[12px] font-bold text-slate-500 dark:text-slate-400 border border-slate-200 dark:border-slate-700 shadow-sm">
                        <i class="fa-solid fa-arrow-pointer mr-1"></i>
                        Interactive Editor: Click to Add ‚Ä¢ Drag to Move ‚Ä¢ Double-click Delete
                    </span>
                </div>

                <!-- Paper Container -->
                <!-- üü¢ ‰øÆÊîπÁÇπ 2: 
                         - ‰ΩøÁî® CSS Âä®ÊÄÅËÆ°ÁÆóÈ´òÂ∫¶Ôºöcalc(100vh - 160px) 
                           (100vh ÂáèÂéª Â§¥ÈÉ®HeaderÈ´òÂ∫¶ + ‰∏ä‰∏ãËæπË∑ù)
                         - ËÆæÁΩÆ width: auto Âíå aspect-ratio
                         - ËøôÊ†∑Á∫∏Âº†‰ºöËá™Âä®Áº©Êîæ‰ª•ÈÄÇÂ∫îÂ±èÂπïÈ´òÂ∫¶ÔºåÊ∞∏Ëøú‰∏ç‰ºöÂá∫Áé∞ÊªöÂä®Êù°
                    -->
                <div class="relative shadow-2xl dark:shadow-black/60 transition-transform origin-center bg-white  h-[75%] md:h-[100%]"
                    style="
                            max-height: calc(100vh - 140px); 
                            aspect-ratio: 210/297; 
                            width: auto;
                            max-width: 95%; /* Èò≤Ê≠¢Âú®Ë∂ÖÁ™ÑÊâãÊú∫‰∏äÊ∫¢Âá∫ */
                         ">

                    <!-- Canvas Wrapper -->
                    <div class="absolute inset-0 bg-white h-full w-full" id="canvas-wrapper">
                        <!-- Loading Overlay -->
                        <div id="canvas-loader"
                            class="hidden absolute inset-0 bg-white/90 dark:bg-slate-900/90 z-50 flex flex-col items-center justify-center backdrop-blur-sm">
                            <div
                                class="w-12 h-12 border-4 border-brand-100 border-t-brand-600 rounded-full animate-spin mb-3">
                            </div>
                            <p class="text-xs font-bold text-brand-700 dark:text-brand-400 uppercase tracking-widest">
                                Processing...</p>
                        </div>
                        <!-- Canvas -->
                        <canvas id="draw-canvas" class="w-full h-full cursor-crosshair block touch-none"></canvas>
                    </div>
                </div>

                <!-- Â∫ïÈÉ®Ê∞¥Âç∞ (Ë£ÖÈ•∞) -->
                <div class="absolute bottom-4 text-[10px] text-slate-900 font-mono opacity-60">
                    A4 Print Preview
                </div>
            </div>
        </main>

    </div>

    <!-- Mobile FAB (Open Config) -->
    <button onclick="toggleDrawer()"
        class="lg:hidden fixed bottom-6 right-6 w-14 h-14 bg-slate-900 dark:bg-brand-600 text-white rounded-full shadow-xl shadow-slate-900/30 flex items-center justify-center z-50 hover:scale-105 active:scale-95 transition-all">
        <i class="fa-solid fa-sliders text-xl"></i>
    </button>
    </div>

    <!-- HIDDEN TEMPLATES -->
    <div class="hidden">
        <!-- 1. Upload Template -->
        <div id="upload-template">
            <div id="drop-zone"
                class="mt-4 border-3 border-dashed border-slate-200 dark:border-slate-700 rounded-[1.5rem] p-12 text-center transition-colors hover:bg-slate-50 dark:hover:bg-slate-800/50 hover:border-brand-400 cursor-pointer group">
                <div
                    class="w-16 h-16 bg-slate-100 dark:bg-slate-800 rounded-full flex items-center justify-center mx-auto mb-4 group-hover:scale-110 transition-transform">
                    <i
                        class="fa-solid fa-file-image text-3xl text-slate-300 dark:text-slate-600 group-hover:text-brand-500 transition-colors"></i>
                </div>
                <p class="text-lg font-bold text-slate-700 dark:text-white">Click to browse</p>
                <p class="text-sm text-slate-400 dark:text-slate-500">or drag file here</p>
                <input id="image-loader" type="file" class="hidden" accept="image/*">
            </div>
        </div>

        <!-- 2. AI Template -->
        <div id="ai-generate-template">
            <div
                class="mt-4 bg-white dark:bg-slate-800 p-6 rounded-[1.5rem] border border-slate-200 dark:border-slate-700 shadow-lg">
                <label class="block text-sm font-bold text-slate-700 dark:text-slate-200 mb-2">What should we
                    draw?</label>
                <textarea id="ai-prompt-input" rows="3" placeholder="e.g. A happy cartoon robot holding a balloon"
                    class="w-full p-4 text-base border border-slate-200 dark:border-slate-600 dark:bg-slate-900 dark:text-white rounded-xl focus:ring-2 focus:ring-accent-500 focus:border-transparent outline-none resize-none transition-all mb-4"></textarea>

                <button id="generate-ai-image-btn"
                    class="w-full py-4 bg-gradient-to-r from-accent-600 to-accent-500 text-white rounded-xl text-base font-bold hover:shadow-lg hover:shadow-accent-500/25 transition-all flex items-center justify-center gap-2 active:scale-[0.98]">
                    <i class="fa-solid fa-wand-magic-sparkles"></i> <span id="generate-button-text">Generate
                        Image</span>
                </button>

                <div id="ai-status-area" class="hidden mt-6 text-center">
                    <div
                        class="inline-block animate-spin w-6 h-6 border-4 border-accent-100 border-t-accent-600 rounded-full mb-2">
                    </div>
                    <p id="ai-status-message"
                        class="text-xs font-bold text-accent-600 dark:text-accent-400 uppercase tracking-wide">Warming
                        up AI...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL: Image Type Selection -->
    <div id="image-type-modal" class="fixed inset-0 z-[100] hidden" aria-modal="true">
        <div class="absolute inset-0 bg-slate-900/80 backdrop-blur-sm transition-opacity"></div>
        <div
            class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-white dark:bg-slate-900 rounded-[2rem] shadow-2xl p-8 w-full max-w-md m-4 transform transition-all border border-slate-100 dark:border-slate-800">
            <div class="text-center mb-8">
                <div
                    class="w-16 h-16 bg-brand-50 dark:bg-brand-900/20 text-brand-600 dark:text-brand-400 rounded-2xl flex items-center justify-center mx-auto mb-4 rotate-3">
                    <i class="fa-solid fa-layer-group text-3xl"></i>
                </div>
                <h3 class="text-2xl font-display font-bold text-slate-900 dark:text-white">One Quick Question</h3>
                <p class="text-slate-500 dark:text-slate-400 mt-2 text-sm leading-relaxed">To give you the best
                    dot-to-dot result, tell us about your image:</p>
            </div>

            <!-- Loader inside modal -->
            <div id="rmbg-loader" class="hidden flex flex-col items-center justify-center py-8">
                <div class="w-12 h-12 border-4 border-brand-100 border-t-brand-600 rounded-full animate-spin mb-4">
                </div>
                <p class="text-sm font-bold text-slate-600 dark:text-slate-300">Removing background...</p>
            </div>

            <div id="modal-actions" class="space-y-3">
                <button id="btn-select-photo"
                    class="w-full py-4 bg-slate-900 dark:bg-white text-white dark:text-slate-900 rounded-xl font-bold hover:bg-black dark:hover:bg-slate-200 transition-all flex items-center justify-center gap-3 shadow-lg hover:-translate-y-0.5">
                    <i class="fa-solid fa-camera"></i> It's a Real Photo
                </button>
                <button id="btn-select-drawing"
                    class="w-full py-4 bg-white dark:bg-slate-800 border-2 border-slate-200 dark:border-slate-700 text-slate-700 dark:text-slate-200 rounded-xl font-bold hover:border-brand-500 hover:text-brand-600 dark:hover:border-brand-500 dark:hover:text-brand-400 transition-all flex items-center justify-center gap-3">
                    <i class="fa-solid fa-pen-nib"></i> Line Drawing / Sketch
                </button>
            </div>
        </div>
    </div>


    <!-- Logic Script -->
    <script>
        // === UI INTERACTION LOGIC ===

        // 1. Dark Mode Toggle
        const themeBtn = document.getElementById('theme-toggle');
        const html = document.documentElement;

        // Check init
        if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            html.classList.add('dark');
        } else {
            html.classList.remove('dark');
        }

        themeBtn.addEventListener('click', () => {
            if (html.classList.contains('dark')) {
                html.classList.remove('dark');
                localStorage.theme = 'light';
            } else {
                html.classList.add('dark');
                localStorage.theme = 'dark';
            }
        });

        // 2. Drawer Logic
        function toggleDrawer() {
            const drawer = document.getElementById('sidebar-drawer');
            const backdrop = document.getElementById('backdrop');
            const isClosed = drawer.classList.contains('mobile-drawer-closed');
            if (isClosed) {
                drawer.classList.remove('mobile-drawer-closed');
                drawer.classList.add('mobile-drawer-open');
                backdrop.classList.remove('hidden');
                document.body.style.overflow = 'hidden';
            } else {
                drawer.classList.remove('mobile-drawer-open');
                drawer.classList.add('mobile-drawer-closed');
                backdrop.classList.add('hidden');
                document.body.style.overflow = '';
            }
        }
        window.addEventListener('resize', () => {
            if (window.innerWidth >= 1024) {
                document.body.style.overflow = '';
                document.getElementById('backdrop')?.classList.add('hidden');
            }
        });

        // 3. Color Picker Sync
        const colorInput = document.getElementById('dot-color-picker');
        const colorHex = document.getElementById('color-hex');
        colorInput.addEventListener('input', (e) => {
            colorHex.textContent = e.target.value.toUpperCase();
        });

        // === CORE GENERATOR LOGIC (Merged) ===
        document.addEventListener('DOMContentLoaded', () => {
            // A4 High Res
            const CANVAS_WIDTH = 2480;
            const CANVAS_HEIGHT = 3508;

            const TEMPLATE_CONFIG = {
                padding: 120,
                headerHeight: 450,
                footerHeight: 200,
                borderColor: '#1e293b', // Dark Slate
                borderWidth: 12,
                borderRadius: 40,
                textColor: '#0f172a'
            };

            const DEFAULT_CONFIG = {
                type: '123',
                fontSize: 20,
                hint: 'original',
                eraseThickness: 5,
                dotRadius: 5,
                dotColor: '#000000'
            };

            let state = {
                originalImage: null,
                canvasDimensions: { width: CANVAS_WIDTH, height: CANVAS_HEIGHT },
                imagePlacement: { x: 0, y: 0, w: 0, h: 0, scale: 1 },
                dots: [],
                draggedDotIndex: -1,
                config: { ...DEFAULT_CONFIG },
                internalHintImage: null,
                pendingFile: null
            };

            // DOM References
            const step1ChoiceArea = document.getElementById('step1-choice-area');
            const uploadChoiceCard = document.getElementById('upload-choice-card');
            const aiChoiceCard = document.getElementById('ai-choice-card');
            const actionUiContainer = document.getElementById('action-ui-container');
            const uploadTemplate = document.getElementById('upload-template');
            const aiGenerateTemplate = document.getElementById('ai-generate-template');
            const inspirationArea = document.getElementById('inspiration-area');

            const imageTypeModal = document.getElementById('image-type-modal');
            const btnSelectPhoto = document.getElementById('btn-select-photo');
            const btnSelectDrawing = document.getElementById('btn-select-drawing');
            const rmbgLoader = document.getElementById('rmbg-loader');
            const modalActions = document.getElementById('modal-actions');

            const generatorMainArea = document.getElementById('generator-main-area');
            const sourceImageInfo = document.getElementById('source-image-info');
            const currentFilename = document.getElementById('current-filename');
            const changeImageBtn = document.getElementById('change-image-btn');
            const drawCanvas = document.getElementById('draw-canvas');
            const drawCtx = drawCanvas.getContext('2d');
            const canvasLoader = document.getElementById('canvas-loader');
            const pointsCounter = document.getElementById('points-counter');
            const clearBtn = document.getElementById('clear-btn');

            const hintTypeRadios = document.getElementsByName('hint-type');
            const dotCountSlider = document.getElementById('dot-count-slider');
            const pointsNumberInput = document.getElementById('points-number-input');
            const pointsMinusBtn = document.getElementById('points-minus-btn');
            const pointsPlusBtn = document.getElementById('points-plus-btn');
            const fontSizeSlider = document.getElementById('font-size-slider');
            const fontSizeValue = document.getElementById('font-size-value');
            const thicknessContainer = document.getElementById('thickness-container');
            const thicknessSlider = document.getElementById('thicknessSlider');
            const thicknessValue = document.getElementById('thicknessValue');
            const dotSizeSlider = document.getElementById('dot-size-slider');
            const dotSizeValue = document.getElementById('dot-size-value');
            const dotColorPicker = document.getElementById('dot-color-picker');
            const downloadPngBtn = document.getElementById('download-png-btn');
            const downloadPdfBtn = document.getElementById('download-pdf-btn');
            const opencvStatus = document.getElementById('opencv-status');
            const statusIndicator = document.getElementById('status-indicator');

            let imageLoader, dropZone, aiPromptInput, generateAiImageBtn, aiStatusArea, aiStatusMessage;

            // --- Utilities ---
            const debounce = (func, delay) => {
                let timeout;
                return function (...args) {
                    clearTimeout(timeout);
                    timeout = setTimeout(() => func.apply(this, args), delay);
                };
            };

            const getEventPos = (canvas, evt) => {
                const rect = canvas.getBoundingClientRect();
                const clientX = evt.touches ? evt.touches[0].clientX : evt.clientX;
                const clientY = evt.touches ? evt.touches[0].clientY : evt.clientY;
                return {
                    x: (clientX - rect.left) * (canvas.width / rect.width),
                    y: (clientY - rect.top) * (canvas.height / rect.height)
                };
            };

            const distance = (p1, p2) => Math.sqrt((p1.x - p2.x) ** 2 + (p1.y - p2.y) ** 2);
            const getLabel = (index) => state.config.type === 'ABC' ? String.fromCharCode(65 + index) : (index + 1).toString();
            const updateClearButton = () => { if (clearBtn) clearBtn.disabled = state.dots.length === 0; };

            // --- Drawing Logic ---
            const drawTemplate = (ctx) => {
                const w = CANVAS_WIDTH;
                const h = CANVAS_HEIGHT;
                const p = TEMPLATE_CONFIG.padding;

                // White Bg
                ctx.fillStyle = '#ffffff';
                ctx.fillRect(0, 0, w, h);

                // Border
                ctx.beginPath();
                if (ctx.roundRect) ctx.roundRect(p, p, w - (p * 2), h - (p * 2), TEMPLATE_CONFIG.borderRadius);
                else ctx.rect(p, p, w - (p * 2), h - (p * 2));
                ctx.lineWidth = TEMPLATE_CONFIG.borderWidth;
                ctx.strokeStyle = TEMPLATE_CONFIG.borderColor;
                ctx.stroke();

                // Header
                ctx.textAlign = 'left';
                ctx.textBaseline = 'alphabetic';

                // Title (Font matches Outfit/Brand)
                ctx.fillStyle = TEMPLATE_CONFIG.textColor;
                ctx.font = 'bold 120px "Outfit", "Plus Jakarta Sans", sans-serif';
                ctx.fillText("Connect Dots", p + 80, p + 180);

                // Subtitle
                const dotCount = state.dots.length > 0 ? state.dots.length : '?';
                ctx.font = '500 60px "Plus Jakarta Sans", sans-serif';
                ctx.fillStyle = '#64748b';
                ctx.fillText(`Connect 1 to ${dotCount}!`, p + 80, p + 280);

                // Name
                ctx.textAlign = 'right';
                ctx.fillStyle = '#94a3b8';
                ctx.font = '500 45px "Plus Jakarta Sans", sans-serif';
                ctx.fillText("Name:", w - p - 400, p + 180);
                ctx.beginPath();
                ctx.moveTo(w - p - 380, p + 180);
                ctx.lineTo(w - p - 80, p + 180);
                ctx.strokeStyle = '#cbd5e1';
                ctx.lineWidth = 4;
                ctx.stroke();

                // Separator
                ctx.beginPath();
                ctx.moveTo(p + 80, p + 340);
                ctx.lineTo(w - p - 80, p + 340);
                ctx.strokeStyle = '#e2e8f0';
                ctx.lineWidth = 6;
                ctx.stroke();

                // Footer
                ctx.textAlign = 'center';
                ctx.fillStyle = '#94a3b8';
                ctx.font = '500 40px "Plus Jakarta Sans", monospace';
                ctx.fillText("Created with GenPrintable.com", w / 2, h - p - 60);
            };

            const drawDots = (context, dots, config = {}) => {
                const displayScale = 3.5;
                dots.forEach(dot => {
                    context.beginPath();
                    context.arc(dot.x, dot.y, config.radius * displayScale, 0, 2 * Math.PI);
                    context.fillStyle = config.color;
                    context.fill();
                    context.lineWidth = 2;
                    context.strokeStyle = '#fff';
                    context.stroke();
                });
            };

            const calculateCentroid = (dots) => {
                if (dots.length === 0) return { x: CANVAS_WIDTH / 2, y: CANVAS_HEIGHT / 2 };
                const total = dots.reduce((acc, dot) => ({ x: acc.x + dot.x, y: acc.y + dot.y }), { x: 0, y: 0 });
                return { x: total.x / dots.length, y: total.y / dots.length };
            };

            const drawNumbers = (context, dots, centroid) => {
                const displayScale = 3.5;
                const fontSize = state.config.fontSize * displayScale;

                context.fillStyle = 'black';
                context.font = `bold ${fontSize}px "Plus Jakarta Sans", sans-serif`;
                context.textAlign = 'center';
                context.textBaseline = 'middle';

                dots.forEach((dot, index) => {
                    const dx = dot.x - centroid.x;
                    const dy = dot.y - centroid.y;
                    const magnitude = Math.sqrt(dx * dx + dy * dy);
                    let nx = 0, ny = -1;
                    if (magnitude > 0) { nx = dx / magnitude; ny = dy / magnitude; }

                    const offset = (state.config.dotRadius * displayScale) + (fontSize * 0.8);
                    context.fillText(getLabel(index), dot.x + nx * offset, dot.y + ny * offset);
                });
            };

            const redrawDrawCanvas = () => {
                const context = drawCtx;
                drawTemplate(context);

                const { x, y, w, h } = state.imagePlacement;

                if (state.originalImage) {
                    if (state.config.hint === 'original') {
                        context.drawImage(state.originalImage, x, y, w, h);
                    } else if (state.config.hint === 'trace') {
                        context.globalAlpha = 0.25;
                        context.drawImage(state.originalImage, x, y, w, h);
                        context.globalAlpha = 1.0;
                    } else if (state.config.hint === 'internal' && state.internalHintImage) {
                        context.drawImage(state.internalHintImage, x, y, w, h);
                    }
                }

                const centroid = calculateCentroid(state.dots);
                drawDots(context, state.dots, { color: state.config.dotColor, radius: state.config.dotRadius });
                drawNumbers(context, state.dots, centroid);

                if (pointsCounter) pointsCounter.textContent = state.dots.length + " Pts";
                updateClearButton();
            };

            const updateConfigAndRedraw = () => {
                state.config.fontSize = parseInt(fontSizeSlider.value, 10);
                state.config.dotRadius = parseInt(dotSizeSlider.value, 10);
                state.config.dotColor = dotColorPicker.value;

                let checkedHint = 'original';
                for (let r of hintTypeRadios) { if (r.checked) checkedHint = r.value; }
                state.config.hint = checkedHint;

                state.config.eraseThickness = parseInt(thicknessSlider.value, 10);

                fontSizeValue.textContent = fontSizeSlider.value;
                dotSizeValue.textContent = dotSizeSlider.value;
                thicknessValue.textContent = thicknessSlider.value;

                if (state.config.hint === 'internal') thicknessContainer.classList.remove('hidden');
                else thicknessContainer.classList.add('hidden');

                if (state.config.hint === 'internal' && typeof cv !== 'undefined' && !state.internalHintImage) {
                    state.internalHintImage = generateInternalHintImage(state.config.eraseThickness);
                }
                if (state.config.hint === 'internal' && typeof cv !== 'undefined') {
                    state.internalHintImage = generateInternalHintImage(state.config.eraseThickness);
                }

                redrawDrawCanvas();
            };

            // --- Image Processing (Internal Lines) ---
            const generateInternalHintImage = (thickness) => {
                if (!state.originalImage || typeof cv === 'undefined') return null;

                const w = state.originalImage.naturalWidth;
                const h = state.originalImage.naturalHeight;

                const tempCanvas = document.createElement('canvas');
                tempCanvas.width = w; tempCanvas.height = h;
                tempCanvas.getContext('2d').drawImage(state.originalImage, 0, 0);

                let src, gray, binary, contours, hierarchy, resultMat = null;

                try {
                    src = cv.imread(tempCanvas);
                    resultMat = src.clone();
                    gray = new cv.Mat();
                    binary = new cv.Mat();

                    cv.cvtColor(src, gray, cv.COLOR_RGBA2GRAY, 0);
                    cv.threshold(gray, binary, 127, 255, cv.THRESH_BINARY_INV | cv.THRESH_OTSU);

                    contours = new cv.MatVector();
                    hierarchy = new cv.Mat();

                    cv.findContours(binary, contours, hierarchy, cv.RETR_EXTERNAL, cv.CHAIN_APPROX_SIMPLE);
                    const drawThickness = Math.max(3, thickness * (w / 600));
                    cv.drawContours(resultMat, contours, -1, new cv.Scalar(255, 255, 255, 255), drawThickness);

                    const offscreenCanvas = document.createElement('canvas');
                    offscreenCanvas.width = w; offscreenCanvas.height = h;
                    cv.imshow(offscreenCanvas, resultMat);

                    return offscreenCanvas;
                } catch (error) {
                    console.error("Hint generation error:", error);
                    return null;
                } finally {
                    if (src) src.delete(); if (gray) gray.delete(); if (binary) binary.delete();
                    if (contours) contours.delete(); if (hierarchy) hierarchy.delete(); if (resultMat) resultMat.delete();
                }
            };

            const loadImageToCanvas = (file) => {
                const reader = new FileReader();
                reader.onerror = () => alert('Error reading file.');
                reader.onload = (event) => {
                    const img = new Image();
                    img.onload = () => {
                        state.originalImage = img;
                        state.internalHintImage = null;

                        drawCanvas.width = CANVAS_WIDTH;
                        drawCanvas.height = CANVAS_HEIGHT;

                        const p = TEMPLATE_CONFIG.padding;
                        const safeX = p + 40;
                        const safeY = p + TEMPLATE_CONFIG.headerHeight;
                        const safeW = CANVAS_WIDTH - (safeX * 2);
                        const safeH = CANVAS_HEIGHT - safeY - TEMPLATE_CONFIG.footerHeight - p;

                        const imgAspect = img.naturalWidth / img.naturalHeight;
                        const safeAspect = safeW / safeH;

                        let renderW, renderH;

                        if (imgAspect > safeAspect) {
                            renderW = safeW; renderH = safeW / imgAspect;
                        } else {
                            renderH = safeH; renderW = safeH * imgAspect;
                        }

                        const renderX = safeX + (safeW - renderW) / 2;
                        const renderY = safeY + (safeH - renderH) / 2;

                        state.imagePlacement = { x: renderX, y: renderY, w: renderW, h: renderH, scale: renderW / img.naturalWidth };
                        state.dots = [];

                        step1ChoiceArea.classList.add('hidden');
                        inspirationArea.classList.add('hidden');
                        generatorMainArea.classList.remove('hidden');

                        if (currentFilename) currentFilename.textContent = file.name;
                        if (sourceImageInfo) sourceImageInfo.classList.remove('hidden');

                        downloadPngBtn.disabled = false;
                        downloadPdfBtn.disabled = false;
                        if (clearBtn) clearBtn.disabled = false;

                        if (opencvScriptLoaded) {
                            canvasLoader.classList.remove('hidden');
                            runAutoDetect();
                        } else {
                            canvasLoader.classList.remove('hidden');
                            loadOpenCv();
                        }
                        updateConfigAndRedraw();
                    };
                    img.src = event.target.result;
                };
                reader.readAsDataURL(file);
            };

            const runAutoDetect = () => {
                if (!state.originalImage || typeof cv === 'undefined') { return; }

                setTimeout(() => {
                    const procW = 800;
                    const procScale = procW / state.originalImage.naturalWidth;
                    const procH = state.originalImage.naturalHeight * procScale;

                    const tempCanvas = document.createElement('canvas');
                    tempCanvas.width = procW; tempCanvas.height = procH;
                    tempCanvas.getContext('2d').drawImage(state.originalImage, 0, 0, procW, procH);

                    let src, gray, binary, contours, hierarchy, channels, alpha, allDots = [];

                    try {
                        src = cv.imread(tempCanvas);
                        gray = new cv.Mat();
                        binary = new cv.Mat();
                        contours = new cv.MatVector();
                        hierarchy = new cv.Mat();

                        channels = new cv.MatVector();
                        cv.split(src, channels);
                        alpha = channels.get(3);
                        let minMax = cv.minMaxLoc(alpha);

                        if (minMax.minVal < 250) {
                            cv.threshold(alpha, binary, 10, 255, cv.THRESH_BINARY);
                        } else {
                            cv.cvtColor(src, gray, cv.COLOR_RGBA2GRAY, 0);
                            cv.threshold(gray, binary, 127, 255, cv.THRESH_BINARY_INV | cv.THRESH_OTSU);
                        }

                        cv.findContours(binary, contours, hierarchy, cv.RETR_EXTERNAL, cv.CHAIN_APPROX_SIMPLE);

                        let significantContours = [];
                        for (let i = 0; i < contours.size(); i++) {
                            const contour = contours.get(i);
                            if (cv.contourArea(contour) > 100) significantContours.push(contour);
                            else contour.delete();
                        }
                        significantContours.sort((a, b) => cv.boundingRect(a).x - cv.boundingRect(b).x);

                        const targetTotalPoints = parseInt(pointsNumberInput.value, 10) || 25;
                        const totalPerimeter = significantContours.reduce((sum, c) => sum + cv.arcLength(c, true), 0);

                        for (const contour of significantContours) {
                            const perimeter = cv.arcLength(contour, true);
                            if (perimeter === 0) continue;

                            const contourPointsTarget = Math.max(3, Math.round(targetTotalPoints * (perimeter / totalPerimeter)));
                            const simplifiedContour = new cv.Mat();

                            let minEps = 0, maxEps = perimeter * 0.1, curEps = maxEps / 2;
                            for (let i = 0; i < 10; i++) {
                                cv.approxPolyDP(contour, simplifiedContour, curEps, true);
                                if (simplifiedContour.rows > contourPointsTarget) minEps = curEps;
                                else if (simplifiedContour.rows < contourPointsTarget) maxEps = curEps;
                                else break;
                                curEps = (minEps + maxEps) / 2;
                            }

                            for (let i = 0; i < simplifiedContour.rows; i++) {
                                let pX = simplifiedContour.data32S[i * 2];
                                let pY = simplifiedContour.data32S[i * 2 + 1];

                                let naturalX = pX / procScale;
                                let naturalY = pY / procScale;

                                let canvasX = (naturalX * state.imagePlacement.scale) + state.imagePlacement.x;
                                let canvasY = (naturalY * state.imagePlacement.scale) + state.imagePlacement.y;

                                allDots.push({ x: canvasX, y: canvasY });
                            }
                            simplifiedContour.delete();
                        }

                        if (allDots.length > targetTotalPoints + 5) {
                            const step = Math.floor(allDots.length / targetTotalPoints);
                            allDots = allDots.filter((_, i) => i % step === 0).slice(0, targetTotalPoints);
                        }

                        state.dots = allDots;
                        redrawDrawCanvas();

                    } catch (error) {
                        console.error("AutoDetect Error", error);
                        state.dots = [];
                    } finally {
                        if (src) src.delete(); if (gray) gray.delete(); if (binary) binary.delete();
                        if (contours) contours.delete(); if (hierarchy) hierarchy.delete();
                        if (channels) channels.delete(); if (alpha) alpha.delete();
                        canvasLoader.classList.add('hidden');
                    }
                }, 100);
            };
            const debouncedAutoDetect = debounce(runAutoDetect, 400);

            // --- Handlers ---
            const handleFile = (file, isFromAI = false) => {
                if (!file || !file.type.startsWith('image/')) return;
                if (isFromAI) {
                    loadImageToCanvas(file);
                } else {
                    state.pendingFile = file;
                    imageTypeModal.classList.remove('hidden');
                }
            };

            const removeBackgroundWithApi = async (file) => {
                const API_ENDPOINT = 'https://ytdlp.vistaflyer.com/api/remove-background';
                try {
                    const formData = new FormData();
                    formData.append('file', file);
                    const response = await fetch(API_ENDPOINT, { method: 'POST', body: formData });
                    if (!response.ok) throw new Error(`API Error`);
                    return await response.blob();
                } catch (e) { throw e; }
            };

            btnSelectDrawing.addEventListener('click', () => {
                imageTypeModal.classList.add('hidden');
                if (state.pendingFile) { loadImageToCanvas(state.pendingFile); state.pendingFile = null; }
            });

            btnSelectPhoto.addEventListener('click', async () => {
                if (!state.pendingFile) return;
                modalActions.classList.add('hidden');
                rmbgLoader.classList.remove('hidden');
                try {
                    const processedBlob = await removeBackgroundWithApi(state.pendingFile);
                    const processedFile = new File([processedBlob], "processed_" + state.pendingFile.name, { type: "image/png" });
                    imageTypeModal.classList.add('hidden');
                    loadImageToCanvas(processedFile);
                } catch (error) {
                    alert("Background removal failed. Using original.");
                    imageTypeModal.classList.add('hidden');
                    loadImageToCanvas(state.pendingFile);
                } finally {
                    modalActions.classList.remove('hidden');
                    rmbgLoader.classList.add('hidden');
                    state.pendingFile = null;
                }
            });

            async function generateAiImageFromLocalBackend(userPrompt) {
                if (!aiStatusArea || !generateAiImageBtn) return;
                aiStatusArea.classList.remove('hidden');
                generateAiImageBtn.disabled = true;

                const apiEndpoint = 'https://connectthedotsprintable.online/api/doubao';
                const finalPrompt = `${userPrompt}, bold outline, simple line art, for coloring book, white background`;

                try {
                    const res = await fetch(apiEndpoint, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ prompt: finalPrompt, size: "1024x1024" })
                    });
                    if (!res.ok) throw new Error(`API Error`);
                    const blob = await res.blob();
                    const file = new File([blob], "AI_Gen.png", { type: blob.type });
                    handleFile(file, true);
                } catch (error) {
                    alert("AI Error: " + error.message);
                } finally {
                    generateAiImageBtn.disabled = false;
                    aiStatusArea.classList.add('hidden');
                }
            }

            // Setup
            function setupActionUI(type) {
                actionUiContainer.innerHTML = '';
                if (type === 'upload') {
                    actionUiContainer.appendChild(uploadTemplate.firstElementChild.cloneNode(true));
                    imageLoader = document.getElementById('image-loader');
                    dropZone = document.getElementById('drop-zone');
                    imageLoader.addEventListener('change', (e) => handleFile(e.target.files[0]));
                    dropZone.addEventListener('click', () => imageLoader.click());
                    dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('border-brand-500'); dropZone.classList.add('bg-brand-50'); });
                    dropZone.addEventListener('dragleave', (e) => { e.preventDefault(); dropZone.classList.remove('border-brand-500'); dropZone.classList.remove('bg-brand-50'); });
                    dropZone.addEventListener('drop', (e) => { e.preventDefault(); handleFile(e.dataTransfer.files[0]); });
                } else if (type === 'ai') {
                    actionUiContainer.appendChild(aiGenerateTemplate.firstElementChild.cloneNode(true));
                    aiPromptInput = document.getElementById('ai-prompt-input');
                    generateAiImageBtn = document.getElementById('generate-ai-image-btn');
                    aiStatusArea = document.getElementById('ai-status-area');
                    generateAiImageBtn.addEventListener('click', () => {
                        const p = aiPromptInput.value.trim();
                        if (p.length > 2) generateAiImageFromLocalBackend(p);
                    });
                }
            }

            uploadChoiceCard.addEventListener('click', () => {
                uploadChoiceCard.classList.add('border-brand-500'); uploadChoiceCard.classList.add('ring-4'); uploadChoiceCard.classList.add('ring-brand-100'); uploadChoiceCard.classList.remove('border-slate-100');
                aiChoiceCard.classList.remove('border-accent-500'); aiChoiceCard.classList.remove('ring-4'); aiChoiceCard.classList.remove('ring-accent-100'); aiChoiceCard.classList.add('border-slate-100');
                setupActionUI('upload');
            });
            aiChoiceCard.addEventListener('click', () => {
                aiChoiceCard.classList.add('border-accent-500'); aiChoiceCard.classList.add('ring-4'); aiChoiceCard.classList.add('ring-accent-100'); aiChoiceCard.classList.remove('border-slate-100');
                uploadChoiceCard.classList.remove('border-brand-500'); uploadChoiceCard.classList.remove('ring-4'); uploadChoiceCard.classList.remove('ring-brand-100'); uploadChoiceCard.classList.add('border-slate-100');
                setupActionUI('ai');
            });

            document.querySelectorAll('#examples-content img').forEach(img => {
                img.addEventListener('click', async () => {
                    const res = await fetch(img.src);
                    const blob = await res.blob();
                    handleFile(new File([blob], "example.webp", { type: blob.type }), true);
                });
            });

            if (changeImageBtn) {
                changeImageBtn.addEventListener('click', () => {
                    if (confirm("Start over?")) location.reload();
                });
            }

            // Interactions
            let lastTapTime = 0, aDotWasJustDeleted = false;

            const handleDrawStart = (e) => {
                if (!state.originalImage) return;
                aDotWasJustDeleted = false;
                const currentTime = new Date().getTime();
                const pos = getEventPos(drawCanvas, e);
                const hitRadius = (state.config.dotRadius * 3.5) + 30;

                if (currentTime - lastTapTime < 300) {
                    const dotIndexToDelete = state.dots.findIndex(dot => distance(dot, pos) < hitRadius);
                    if (dotIndexToDelete !== -1) {
                        state.dots.splice(dotIndexToDelete, 1);
                        redrawDrawCanvas();
                        aDotWasJustDeleted = true;
                    }
                    lastTapTime = 0; return;
                }
                lastTapTime = currentTime;

                state.draggedDotIndex = state.dots.findIndex(dot => distance(dot, pos) < hitRadius);
                if (state.draggedDotIndex !== -1) {
                    drawCanvas.style.cursor = 'grabbing';
                    e.preventDefault();
                }
            };

            const handleDrawMove = (e) => {
                if (state.draggedDotIndex === -1) return;
                e.preventDefault();
                state.dots[state.draggedDotIndex] = getEventPos(drawCanvas, e);
                redrawDrawCanvas();
            };

            const handleDrawEnd = (e) => {
                if (state.draggedDotIndex === -1 && state.originalImage && !aDotWasJustDeleted) {
                    const pos = getEventPos(drawCanvas, e);
                    if (state.dots.findIndex(dot => distance(dot, pos) < 20) === -1) {
                        state.dots.push(pos);
                    }
                }
                state.draggedDotIndex = -1;
                drawCanvas.style.cursor = 'crosshair';
                redrawDrawCanvas();
            };

            drawCanvas.addEventListener('mousedown', handleDrawStart);
            drawCanvas.addEventListener('mousemove', handleDrawMove);
            drawCanvas.addEventListener('mouseup', handleDrawEnd);
            drawCanvas.addEventListener('touchstart', handleDrawStart, { passive: false });
            drawCanvas.addEventListener('touchmove', handleDrawMove, { passive: false });
            drawCanvas.addEventListener('touchend', handleDrawEnd);

            const handleDownload = (format) => {
                const filename = `connect-dots.${format}`;
                if (format === 'png') {
                    const link = document.createElement('a');
                    link.download = filename;
                    link.href = drawCanvas.toDataURL('image/png');
                    link.click();
                } else if (format === 'pdf') {
                    if (typeof window.jspdf === 'undefined') return alert('PDF lib missing');
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF({ orientation: 'p', unit: 'mm', format: 'a4' });
                    doc.addImage(drawCanvas.toDataURL('image/jpeg', 0.9), 'JPEG', 0, 0, 210, 297);
                    doc.save(filename);
                }
            };
            if (downloadPngBtn) downloadPngBtn.addEventListener('click', () => handleDownload('png'));
            if (downloadPdfBtn) downloadPdfBtn.addEventListener('click', () => handleDownload('pdf'));

            const updatePointsValue = (val) => {
                dotCountSlider.value = val; pointsNumberInput.value = val;
                if (state.originalImage) debouncedAutoDetect();
            };
            pointsMinusBtn.addEventListener('click', () => updatePointsValue(parseInt(pointsNumberInput.value) - 5));
            pointsPlusBtn.addEventListener('click', () => updatePointsValue(parseInt(pointsNumberInput.value) + 5));
            dotCountSlider.addEventListener('input', (e) => updatePointsValue(e.target.value));

            [fontSizeSlider, dotSizeSlider, dotColorPicker, thicknessSlider].forEach(el => el.addEventListener('input', updateConfigAndRedraw));
            Array.from(hintTypeRadios).forEach(el => el.addEventListener('change', updateConfigAndRedraw));
            if (clearBtn) clearBtn.addEventListener('click', () => { state.dots = []; redrawDrawCanvas(); });

            let opencvScriptLoaded = false;
            function loadOpenCv() {
                if (opencvScriptLoaded) return;
                const script = document.createElement('script');
                script.src = 'https://pub-476193f3c5084ebaabd517e2c8788715.r2.dev/opencv.js';
                script.async = true;
                script.onload = () => {
                    opencvScriptLoaded = true;
                    if (opencvStatus) {
                        opencvStatus.textContent = "Ready";
                        statusIndicator.classList.remove('bg-slate-300');
                        statusIndicator.classList.add('bg-green-500');
                        statusIndicator.classList.remove('animate-pulse');
                    }
                };
                document.body.appendChild(script);
            }
            ['click', 'touchstart'].forEach(evt => document.addEventListener(evt, loadOpenCv, { once: true }));

            resetGeneratorState();

            function resetGeneratorState() {
                state.originalImage = null; state.dots = [];
                generatorMainArea.classList.add('hidden');
                step1ChoiceArea.classList.remove('hidden');
                inspirationArea.classList.remove('hidden');
                uploadChoiceCard.click();
            }
        });
    </script>
</body>

</html>